@page "/invoices"
@using LIT.Smabu.Domain.Shared.Common;
@using LIT.Smabu.Shared.Invoices;
@using Microsoft.AspNetCore.Authorization;
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication;
@inject HttpClient Http
@inject PageInfoService pageInfoService;
@attribute [Authorize]


<MudContainer>
    <MudStack Row Justify="Justify.SpaceBetween">
         <MudText Typo="Typo.h4">Rechnungen</MudText>
         <MudButtonGroup>
             <MudButton Href="/invoices/create" StartIcon="@Icons.Material.Filled.Add">Neu</MudButton>
         </MudButtonGroup>
     </MudStack>

     <MudDataGrid Items="@invoices" Groupable="true">
         <Columns>
             <PropertyColumn Property="x => x.Number.ToShortString()" Title="#" Groupable="false" />
             <PropertyColumn Property="x => x.FiscalYear" Title="Steuerjahr">
                 <GroupTemplate>
                     <span style="font-weight:bold">
                         @context.Grouping.Key
                         <MudChip Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small">@context.Grouping.Count()</MudChip>
                         <MudChip Variant="Variant.Outlined" Color="Color.Success" Size="Size.Small">@Currency.GetEuro().Format(@context.Grouping.Sum(x => x.Amount))</MudChip>
                     </span>
                 </GroupTemplate>
             </PropertyColumn>
             <PropertyColumn Property="x => x.Customer.Name" Title="Kunde">
                 <GroupTemplate>
                     <span style="font-weight:bold">
                         @context.Grouping.Key
                         <MudChip Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small">@context.Grouping.Count()</MudChip>
                         <MudChip Variant="Variant.Outlined" Color="Color.Success" Size="Size.Small">@Currency.GetEuro().Format(@context.Grouping.Sum(x => x.Amount))</MudChip>
                     </span>
                 </GroupTemplate>
             </PropertyColumn>
             <PropertyColumn Property="x => x.PerformancePeriod.To.GetValueOrDefault().ToShortDateString()" SortBy="x => x.PerformancePeriod.To ?? null" Title="Leistungsdatum" Groupable="false" />
             <PropertyColumn Property="x => (Currency.GetEuro().Format(x.Amount))" SortBy="x => x.Amount" Title="Summe" Groupable="false" CellStyle="text-align: right" />
             <TemplateColumn Groupable="false">
                 <CellTemplate>
                     <MudStack Row>
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Href="@($"/invoices/{context.Item.Id}")" Color="@Color.Default" Size="Size.Small" title="Öffnen"></MudIconButton>
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Href="@($"/invoices/{context.Item.Id}/delete")" Color="@Color.Error" Size="Size.Small" title="Löschen"></MudIconButton>
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
</MudContainer>

@code {
    @inject NavigationManager NavigationManager;
    private InvoiceDTO[]? invoices;

    protected override async Task OnInitializedAsync()
    {
        this.pageInfoService.ShowBusyOverlay();
        try
        {
            invoices = await Http.GetFromJsonAsync<InvoiceDTO[]>("Invoices");
        }
        catch (AccessTokenNotAvailableException exception)
        {
            exception.Redirect();
        }
        finally
        {
            this.pageInfoService.HideBusyOverlay();
        }
    }
}