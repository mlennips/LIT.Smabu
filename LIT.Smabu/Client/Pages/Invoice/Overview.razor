@page "/invoices"
@using LIT.Smabu.Domain.Shared.Common;
@using LIT.Smabu.Shared.Invoices;
@using Microsoft.AspNetCore.Authorization;
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication;
@inject HttpClient Http
@attribute [Authorize]


<MudContainer Class="mt-8">
    <MudStack Row Justify="Justify.SpaceBetween">
         <MudText Typo="Typo.h6">Rechnungen</MudText>
         <MudButtonGroup>
             <MudButton Href="/invoices/create" StartIcon="@Icons.Material.Filled.Add">Neu</MudButton>
         </MudButtonGroup>
     </MudStack>

     <MudDataGrid Items="@invoices">
         <Columns>
             <PropertyColumn Property="x => x.Number.ToLongString()" Title="#" />
             <PropertyColumn Property="x => x.FiscalYear" Title="Steuerjahr" />
             <PropertyColumn Property="x => x.Customer.Name" Title="Kunde" />
             <PropertyColumn Property="x => x.PerformancePeriod.To.ToShortDateString()" Title="Leistungsdatum" />
             <PropertyColumn Property="x => (Currency.GetEuro().Format(x.Amount))" SortBy="x => x.Amount" Title="Summe" CellStyle="text-align: right" />

             <TemplateColumn CellClass="d-flex justify-end">
                 <CellTemplate>
                     <MudStack Row>
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Href="@($"/invoices/{context.Item.Id}")" Color="@Color.Default" Size="Size.Small" title="Öffnen"></MudIconButton>
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Href="@($"/invoices/{context.Item.Id}/delete")" Color="@Color.Error" Size="Size.Small" title="Löschen"></MudIconButton>
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
</MudContainer>

@code {
    @inject NavigationManager NavigationManager;
    private InvoiceDTO[]? invoices;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            invoices = await Http.GetFromJsonAsync<InvoiceDTO[]>("Invoices");
        }
        catch (AccessTokenNotAvailableException exception)
        {
            exception.Redirect();
        }
    }
}