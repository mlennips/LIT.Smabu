@inject HttpClient Http
@inject PageInfoService pageInfoService;
@page "/"
@using LIT.Smabu.Client.Services;
@using LIT.Smabu.Shared.Dashboards;

<PageTitle>Smabu</PageTitle>

<AuthorizeView>
    <Authorized>
        @if(this.model != null)
        {
            <MudContainer MaxWidth="MaxWidth.False">
                <MudGrid>
                    <MudItem xs="12" sm="6" md="4">
                        <MudCard>
                            <MudCardContent>
                                <MudText Typo="Typo.h6">Aktuelle Umsätze</MudText>
                                <MudText Typo="Typo.body2"> 3 Monate: @model.Sales3Month</MudText>
                                <MudText Typo="Typo.body2"> 6 Monate: @model.Sales6Month</MudText>
                                <MudText Typo="Typo.body2">12 Monate: @model.Sales12Month</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudCard>
                            <MudCardContent>
                                <MudText Typo="Typo.h6">Umsatzstärkste Kunden</MudText>
                                <MudText Typo="Typo.body2">@model.BestSalesCustomer1Name @model.BestSalesCustomer1Value</MudText>
                                <MudText Typo="Typo.body2">@model.BestSalesCustomer2Name @model.BestSalesCustomer2Value</MudText>
                                <MudText Typo="Typo.body2">@model.BestSalesCustomer3Name @model.BestSalesCustomer3Value</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" sm="12" md="4">
                        <MudCard>
                            <MudCardContent>
                                <MudText Typo="Typo.h6">Gesamtumsatz</MudText>
                                <MudText Typo="Typo.body2">Total: @model.TotalSales</MudText>
                                <MudText Typo="Typo.body2">2023: @model.SalesCurrentYear</MudText>
                                <MudText Typo="Typo.body2">2022: @model.SalesLastYear</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudGrid>
                            <MudItem xs="12">
                                <MudCard Elevation="1">
                                    <MudCardContent>
                                        <MudText>Story of the day</MudText>
                                        <MudText Typo="Typo.body2">The quick, brown fox jumps over a lazy dog.</MudText>
                                    </MudCardContent>
                                    <MudCardActions>
                                        <MudButton Variant="Variant.Text" Color="Color.Primary">Learn More</MudButton>
                                    </MudCardActions>
                                </MudCard>
                            </MudItem>
                            <MudItem xs="12">
                                <MudCard Elevation="1">
                                    <MudCardContent>
                                        <MudText>Story of the day</MudText>
                                        <MudText Typo="Typo.body2">The quick, brown fox jumps over a lazy dog.</MudText>
                                    </MudCardContent>
                                    <MudCardActions>
                                        <MudButton Variant="Variant.Text" Color="Color.Primary">Learn More</MudButton>
                                    </MudCardActions>
                                </MudCard>
                            </MudItem>
                        </MudGrid>
                    </MudItem>
                    <MudItem xs="12" sm="6" Class="d-flex">
                        <MudCard Elevation="1" Class="flex-1">
                            <MudCardContent>
                                <MudText>Story of the day</MudText>
                                <MudText Typo="Typo.body2">The quick, brown fox jumps over a lazy dog.</MudText>
                            </MudCardContent>
                            <MudCardActions>
                                <MudButton Variant="Variant.Text" Color="Color.Primary">Learn More</MudButton>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudCard>
                            <MudCardContent>
                                <MudText>Offene Rechnungen</MudText>
                                <MudText Typo="Typo.body2">The quick, brown fox jumps over a lazy dog.</MudText>
                            </MudCardContent>
                            <MudCardActions>
                                <MudButton Variant="Variant.Text" Color="Color.Primary">Learn More</MudButton>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudCard>
                            <MudCardContent>
                                <MudText>Story of the day</MudText>
                                <MudText Typo="Typo.body2">The quick, brown fox jumps over a lazy dog.</MudText>
                            </MudCardContent>
                            <MudCardActions>
                                <MudButton Variant="Variant.Text" Color="Color.Primary">Learn More</MudButton>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                    <MudItem xs="12" sm="12" md="4">
                        <MudCard>
                            <MudCardContent>
                                <MudText>Story of the day</MudText>
                                <MudText Typo="Typo.body2">The quick, brown fox jumps over a lazy dog.</MudText>
                            </MudCardContent>
                            <MudCardActions>
                                <MudButton Variant="Variant.Text" Color="Color.Primary">Learn More</MudButton>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                </MudGrid>
            </MudContainer>
        }
    </Authorized>
    <NotAuthorized>
        <MudStack>
            <MudText Typo="Typo.h4">Willkommen!</MudText>
            <MudText Typo="Typo.body1">Bitte einloggen</MudText>
        </MudStack>
    </NotAuthorized>
</AuthorizeView>

@code {
    [CascadingParameter] private Task<AuthenticationState> authenticationStateTask { get; set; }

    public HomeDashboardDTO model;

    protected override async Task OnInitializedAsync()
    {
        this.pageInfoService.ShowBusyOverlay();
        var authenticationState = await authenticationStateTask;
        if (authenticationState?.User?.Identity?.IsAuthenticated ?? false)
        {
            this.model = await Http.GetFromJsonAsync<HomeDashboardDTO>("home/dashboard") ?? throw new Exception("NotFound");
            await TempImportAsync();
        }
        this.pageInfoService.HideBusyOverlay();
    }

    private async Task TempImportAsync()
    {
        try
        {
            var customer = await Http.PostAsync("home/import", null) ?? throw new Exception("NotFound");
        }
        catch (Exception)
        {

        }
    }
}